
document.getElementById('scan-btn').addEventListener('click', async function() {
    if (!confirm('您确定要扫描蓝牙设备吗？此操作需要您的授权。')) {
        addMessage(document.getElementById('output'), '扫描已取消', 'received');
        return;
    }

    try {
        if (!navigator.bluetooth) {
            throw new Error('当前浏览器不支持 Web Bluetooth API，请使用最新版 Chrome 浏览器。');
        }

        // 修改: 使用更通用的 optionalServices 或不指定服务
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            // optionalServices: [] // 不指定服务，寻找所有设备
            optionalServices: ['generic_access', 'generic_attribute'] // 使用更通用的服务
        });

        bluetoothDevice = device;
        const select = document.getElementById('bluetooth-select');
        select.innerHTML = '<option value="">--请选择设备--</option>';
        select.innerHTML += `<option value="${device.id}">${device.name || '未知设备'}</option>`;
        addMessage(document.getElementById('output'), `已发现蓝牙设备：${device.name || '未知设备'}`, 'received');
    } catch (error) {
        let errorMessage = error.message;
        if (error.name === 'NotFoundError') {
            errorMessage = '未找到可用的蓝牙设备，请检查设备是否已开启并配对。';
        } else if (error.name === 'SecurityError') {
            errorMessage = '安全错误：浏览器未获得访问蓝牙设备的权限，请检查设置。';
        }
        // 增强: 提供更详细的错误信息
        console.error('扫描设备失败:', error);
        addMessage(document.getElementById('output'), `扫描失败：${errorMessage}`, 'received');
    }
});
